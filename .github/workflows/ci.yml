name: Laravel Deploy (Debug)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Debug secrets presence
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "❌ SERVER_IP is EMPTY"
            exit 1
          else
            echo "✅ SERVER_IP is set"
          fi

          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "❌ DEPLOY_KEY is EMPTY"
            exit 1
          else
            echo "✅ DEPLOY_KEY is set"
          fi

      - name: Deploy to server (SSH debug)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          debug: true
          script: |
            whoami
            pwd
            cd /var/www/SmartRegistration_backend
            git status
            git fetch origin
            git reset --hard origin/main
            php artisan migrate --force
            php artisan config:clear
            php artisan cache:clear
